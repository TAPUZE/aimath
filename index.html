<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专 转拽 AI 专转</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; } 
        .math-problem-display p { margin-bottom: 0.5rem; }
        .math-problem-display { font-size: 1.25rem; font-weight: 600; text-align: center; }
        .math-problem-display .latex-formula { display: inline-block; font-family: 'Times New Roman', serif; font-style: italic; font-size: 1.25em; line-height: 1; white-space: nowrap; margin: 0 0.2em; }
        .rtl-text { direction: rtl; text-align: right; }
        
        .chat-message-user { background-color: #DBEAFE; align-self: flex-end; text-align: right; border-radius: 0.75rem 0.75rem 0.25rem 0.75rem; padding: 0.75rem 1rem; margin-bottom: 0.5rem; max-width: 80%; }
        .chat-message-ai { background-color: #eef2ff; align-self: flex-start; text-align: right; border-radius: 0.75rem 0.75rem 0.75rem 0.25rem; padding: 1rem 1.25rem; margin-bottom: 0.5rem; border: 1px solid #c7d2fe; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1.05em; line-height: 1.6; max-width: 80%; }

        #mathBotToggleContainer { position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; display: flex; flex-direction: column-reverse; align-items: center; }
        #mathBotToggle { width: 4rem; height: 4rem; background-color: #4f46e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s ease-in-out; }
        #mathBotToggle:hover { transform: scale(1.1); background-color: #4338ca; }
        #mathBotToggle svg { width: 2rem; height: 2rem; }
        #proactiveTipBubble { background-color: #6366f1; color: white; padding: 0.5rem 1rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06); margin-bottom: 0.5rem; max-width: 250px; font-size: 0.875rem; text-align: center; opacity: 0; transform: translateY(10px) scale(0.95); visibility: hidden; transition: opacity 0.3s ease-out,transform 0.3s ease-out,visibility 0.3s linear; pointer-events: none; }
        #proactiveTipBubble.visible { opacity: 1; transform: translateY(0) scale(1); visibility: visible; }
        #mathBotContainer { position: fixed; bottom: calc(2rem + 4rem + 1rem); right: 2rem; width: 360px; height: 550px; max-height: calc(100vh - 8rem); background-color: white; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04); z-index: 999; display: flex; flex-direction: column; overflow: hidden; transform: translateY(100%) scale(0.8); opacity: 0; visibility: hidden; transition: transform 0.3s cubic-bezier(0.68,-0.55,0.27,1.55),opacity 0.3s ease-out,visibility 0.3s linear; }
        #mathBotContainer.expanded { transform: translateY(0) scale(1); opacity: 1; visibility: visible; }
        #chatHeader { background-color: #4f46e5; color: white; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
        #chatHeader h3 { font-weight: 600; }
        #closeChatButton { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; line-height: 1; }
        #closeChatButton:hover { color: #c7d2fe; }
        #chatMessagesDisplay { flex-grow: 1; overflow-y: auto; padding: 1rem; background-color: #f9fafb; }
        #chatInputContainer { border-top: 1px solid #e5e7eb; padding: 0.75rem; background-color: white; display: flex; }
        #chatInputContainer textarea { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
        #chatInputContainer button { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        #pasteZone { border: 2px dashed #cbd5e1; padding: 1rem; text-align: center; color: #64748b; border-radius: 0.5rem; margin-top: 0.5rem; cursor: default; }
        #pasteZone:hover { border-color: #94a3b8; background-color: #f8fafc; }
        
        .top-button { position: absolute; top: 1.5rem; z-index: 50; background-color: #e0e7ff; color: #3730a3; border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: background-color 0.2s; }
        .top-button:hover { background-color: #c7d2fe; }
        #settingsButton { left: 1.5rem; }
        #historyButton { left: 4.5rem; } 

        .collapsible-menu { transition: max-height 0.4s ease-out, opacity 0.3s ease-out, margin-bottom 0.4s ease-out; overflow: hidden; max-height: 0; opacity: 0; margin-bottom: 0; }
        .collapsible-menu.expanded { max-height: 1000px; opacity: 1; margin-bottom: 1.5rem; }
        #historyPanelContent { max-height: 300px; overflow-y: auto; }
        #aiRecommendationsContent { max-height: 200px; overflow-y: auto; background-color: #f3e8ff; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }

        #whiteboardModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        #whiteboardModal.visible { opacity: 1; visibility: visible; }
        #whiteboardContainer { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; width: 90%; max-width: 800px; height: 80%; max-height: 600px; }
        #drawingBoard { border: 1px solid #ccc; cursor: crosshair; touch-action: none; width: 100%; height: 100%; flex-grow: 1; }
        #whiteboardControls { margin-top: 0.5rem; display: flex; justify-content: space-around; gap: 0.5rem; padding: 0.5rem 0; }
        #whiteboardControls button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; }
        #openWhiteboardButton { display: inline-flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-8 flex flex-col items-center font-sans text-gray-800">

    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200 rtl-text mb-24 relative"> 
        <button id="settingsButton" class="top-button" aria-label="专转">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 1.905c-.007.379.137.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.759 6.759 0 010-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>
        <button id="historyButton" class="top-button" aria-label="住专 转">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
        </button>

        <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-700 mb-6">专 转拽 AI 专转</h1>

        <div id="settingsMenu" class="collapsible-menu">
             <div class="bg-gray-100 rounded-lg p-5 border border-gray-300">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-3 text-center">专转</h2>
                <p class="text-sm text-gray-600 mb-1">驻转 API 砖 Gemini:</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="password" id="apiKeyInput" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder=" 转 驻转 -API ...">
                    <button id="saveApiKeyButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">砖专 驻转 API</button>
                </div>
                <p id="apiKeyStatus" class="mt-2 text-sm text-center text-green-700 hidden"></p>
            </div>
        </div>
        <div id="historyMenu" class="collapsible-menu">
            <div class="bg-teal-50 rounded-lg p-5 border border-teal-200">
                 <h2 class="text-xl sm:text-2xl font-semibold text-teal-800 mb-3 text-center">住专 转</h2>
                 <div id="historyPanelContent" class="bg-white p-3 rounded border border-gray-200 mb-4 text-sm">
                     住专 注.
                 </div>
                 <div id="aiRecommendationsContent" class="hidden text-sm"></div>
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <button id="exportCsvButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">爪 -CSV</button>
                    <button id="exportJsonButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">爪 -JSON</button>
                    <button id="getRecommendationsButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">拽 爪转</button>
                 </div>
            </div>
        </div>

        <div class="bg-gray-50 rounded-lg p-5 mb-6 border border-gray-200">
             <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-3 text-center">专 砖转 专转</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <div> <label for="moduleSelect" class="block text-sm font-medium text-gray-700 mb-1">:</label> <select id="moduleSelect" class="w-full p-2 border border-gray-300 rounded-lg"></select> </div>
                <div> <label for="yearSelect" class="block text-sm font-medium text-gray-700 mb-1">砖:</label> <select id="yearSelect" class="w-full p-2 border border-gray-300 rounded-lg"></select> </div>
                <div> <label for="questionSelect" class="block text-sm font-medium text-gray-700 mb-1">砖:</label> <select id="questionSelect" class="w-full p-2 border border-gray-300 rounded-lg"></select> </div>
            </div>
            <button id="loadProblemButton" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">注 砖</button>
        </div>

        <div id="problemDisplaySection" class="bg-blue-50 rounded-lg p-5 mb-6 border border-blue-200"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div id="initialAnswerSection">
                <label for="studentAnswer" class="block text-lg font-medium text-gray-700 mb-2">转砖 砖:</label>
                <textarea id="studentAnswer" class="w-full p-3 border border-gray-300 rounded-lg min-h-[160px]" rows="5" placeholder="拽 转 转砖转 转 砖 驻转专 ..."></textarea>
                 <button id="openWhiteboardButton" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-lg text-sm inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                    驻转  拽
                </button>
            </div>
            <div id="imageUploadSection">
                <label for="imageUpload" class="block text-lg font-medium text-gray-700 mb-2">注 注转 :</label>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <div id="pasteZone" class="mt-2"> 拽 爪 住  (Ctrl+V)</div>
                <p id="selectedImageName" class="mt-2 text-sm text-gray-600"></p>
                 <div class="mt-4">
                    <button id="getHintButton" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition w-full sm:w-auto">
                         拽 专
                    </button>
                    <div id="hintDisplay" class="mt-3 p-3 bg-orange-100 text-orange-800 rounded-lg hidden text-center"></div>
                </div>
            </div>
        </div>
         <button id="checkAnswerButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mb-6">拽 转砖 / 拽 砖</button>
        
        <div id="checkAnswerResultDisplay" class="p-4 rounded-lg mb-6 text-center font-semibold text-lg hidden"></div>
        <button id="acknowledgeFeedbackButton" class="hidden mt-2 w-full sm:w-auto mx-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">转, 砖</button>

        <div id="stepByStepSection" class="bg-yellow-50 rounded-lg p-5 mb-6 border border-yellow-200 hidden">
            <h2 class="text-xl sm:text-2xl font-semibold text-yellow-800 mb-3 text-center">砖 <span id="currentStepNumber">1</span></h2>
            <div id="currentSubProblemQuestion" class="math-problem-display text-xl font-semibold text-center mb-4"></div>
            <label for="currentSubProblemAnswer" class="block text-lg font-medium text-gray-700 mb-2">转砖转:</label>
            <textarea id="currentSubProblemAnswer" class="w-full p-3 border border-gray-300 rounded-lg min-h-[60px]" rows="3"></textarea>
            <button id="checkSubStepButton" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">拽 砖</button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <button id="simplifyProblemButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">驻砖 注</button>
            <button id="makeHarderProblemButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">驻 拽砖 转专</button>
        </div>

        <div id="loadingIndicator" class="flex items-center justify-center mb-4 text-indigo-600 hidden"> <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg> 注... </div>
        <div id="errorMessageDisplay" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"> <strong class="font-bold">砖!</strong> <span id="errorMessageText" class="block sm:inline"></span> </div>
        <div id="aiFeedbackDisplay" class="bg-purple-50 rounded-lg p-5 border border-purple-200 mt-6 hidden"> <h2 class="text-xl sm:text-2xl font-semibold text-purple-800 mb-3 text-center">砖 AI</h2> <div id="aiFeedbackContent" class="text-gray-700 leading-relaxed"></div> </div>
    </div>

    <div id="mathBotToggleContainer">
        <div id="proactiveTipBubble"></div>
        <div id="mathBotToggle"> 
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5h0v-1.5m0 0h0m0 0H9.75m10.125 0a9.75 9.75 0 01-9.75 9.75c-4.418 0-8.268-2.903-9.5-7.036m19 0c-.162 2.097-.735 4.034-1.595 5.682A9.723 9.723 0 0112 21.75c-2.602 0-4.967-.992-6.797-2.64S2.25 14.602 2.25 12c0-1.63.396-3.173 1.099-4.518M7.5 10.5h.008v.008H7.5V10.5zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 4.5h.008v.008h-.008V15zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125-4.5h.008v.008h-.008V10.5zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg> 
        </div>
        <p class="text-xs text-gray-500 mt-1 text-center">砖 转  "住专..."</p>
    </div>

    <div id="mathBotContainer">
        <div id="chatHeader"> <h3>爪' 转 注 AI</h3> <button id="closeChatButton" aria-label="住专 爪'">&times;</button> </div>
        <div id="chatMessagesDisplay" class="flex flex-col h-full bg-white border-gray-300 p-4 overflow-y-auto"></div>
        <div id="chatInputContainer" class="flex p-3 bg-gray-100 border-t border-gray-200">
            <textarea id="chatInput" class="flex-grow p-3 border border-gray-300 rounded-l-lg" rows="2" placeholder="砖 砖 转转..."></textarea>
            <button id="sendChatMessageButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-r-lg">砖</button>
        </div>
         <p class="text-xs text-gray-500 p-2 text-center bg-gray-100">砖转砖 爪' 砖转 转, 住专 ("住专...")  注专.</p>
    </div>

    <div id="whiteboardModal">
        <div id="whiteboardContainer">
            <canvas id="drawingBoard"></canvas>
            <div id="whiteboardControls">
                <button id="saveWhiteboardButton" class="bg-green-500 hover:bg-green-600 text-white">砖专 拽抓 砖转砖</button>
                <button id="clearWhiteboardButton" class="bg-yellow-500 hover:bg-yellow-600 text-white">拽 </button>
                <button id="closeWhiteboardButton" class="bg-red-500 hover:bg-red-600 text-white">住专 </button>
            </div>
        </div>
    </div>

    <script>
        // Global state variables
        let geminiApiKey = '';
        let currentProblem = null;
        let isInStepByStepMode = false;
        let currentStepIndex = 0;
        let stepByStepHistory = []; 
        let currentSubProblemQuestionText = ''; 
        let chatMessages = [];
        let proactiveTipTimeout = null; 
        let userHistory = []; 

        // DOM Elements - Declared with let, will be assigned in window.onload
        let settingsButton, historyButton, settingsMenu, historyMenu, historyPanelContent,
            exportCsvButton, exportJsonButton, getRecommendationsButton, aiRecommendationsContent,
            getHintButton, hintDisplay, apiKeyInput, saveApiKeyButton, apiKeyStatus,
            moduleSelect, yearSelect, questionSelect, loadProblemButton, problemDisplaySection,
            studentAnswerInput, checkAnswerButton, checkAnswerResultDisplay, acknowledgeFeedbackButton,
            stepByStepSection, currentStepNumberSpan, currentSubProblemQuestionDiv,
            currentSubProblemAnswerInput, checkSubStepButton, imageUploadInput, pasteZone,
            selectedImageName, simplifyProblemButton, makeHarderProblemButton, loadingIndicator,
            errorMessageDisplay, errorMessageText, aiFeedbackDisplay, aiFeedbackContent,
            mathBotToggleContainer, mathBotToggle, proactiveTipBubble, mathBotContainer,
            closeChatButton, chatMessagesDisplay, chatInput, sendChatMessageButton,
            openWhiteboardButton, whiteboardModal, drawingBoard, saveWhiteboardButton,
            clearWhiteboardButton, closeWhiteboardButton, whiteboardCtx,
            isDrawingOnWhiteboard = false, lastX, lastY;


        const GEMINI_MODEL_NAME = 'gemini-1.5-flash-latest'; 
        const bagrutQuestionsData = { /* ... Full data from previous version ... */ };
        function ensureSampleData() { /* ... Full function from previous version... */ }
        ensureSampleData(); 

        // --- History Management ---
        function loadUserHistory() { /* ... same as v6 ... */ }
        function saveUserHistory() { /* ... same as v6 ... */ }
        function addHistoryEntry(problemId, questionText, isCorrect, usedStepByStep, typedAnswer = "") { /* ... same as v6 ... */ }
        function displayUserHistory() { /* ... same as v6 ... */ }

        // --- Export Functions ---
        function downloadData(filename, data, type) { /* ... same as v6 ... */ }
        function exportAsCsv() { /* ... same as v6 ... */ }
        function exportAsJson() { /* ... same as v6 ... */ }
        
        // --- AI Recommendations ---
        async function getAIRecommendations() { /* ... same as v6 ... */ }

        // --- Utility Functions (Continued) ---
        function showLoading(show) { if(loadingIndicator) loadingIndicator.classList.toggle('hidden', !show); }
        function showErrorMessage(message) { if(errorMessageText && errorMessageDisplay) { errorMessageText.textContent = message; errorMessageDisplay.classList.remove('hidden'); }}
        function hideErrorMessage() { if(errorMessageDisplay) errorMessageDisplay.classList.add('hidden'); if(errorMessageText) errorMessageText.textContent = ''; }
        function sanitizeAndFormatLatex(text) { 
            if (typeof text !== 'string') return '';
            return text.replace(/\$\$(.*?)\$\$/g, '<span class="latex-formula">$$$1$$</span>')
                       .replace(/\$(.*?)\$/g, '<span class="latex-formula">$1</span>');
        }
        function resetUIState() {
            hideErrorMessage();
            if(aiFeedbackDisplay) aiFeedbackDisplay.classList.add('hidden');
            if(aiFeedbackContent) aiFeedbackContent.innerHTML = '';
            if(checkAnswerResultDisplay) checkAnswerResultDisplay.classList.add('hidden');
            if(acknowledgeFeedbackButton) acknowledgeFeedbackButton.classList.add('hidden');
            if(hintDisplay) hintDisplay.classList.add('hidden'); 
            if(hintDisplay) hintDisplay.innerHTML = '';
            if(getHintButton) getHintButton.disabled = false; 
            if(studentAnswerInput) studentAnswerInput.value = '';
            if(imageUploadInput) imageUploadInput.value = ''; 
            if(selectedImageName) selectedImageName.textContent = '';
            if(pasteZone) pasteZone.textContent = ' 拽 爪 住  (Ctrl+V)'; 
            isInStepByStepMode = false;
            if(stepByStepSection) stepByStepSection.classList.add('hidden');
            if(currentSubProblemAnswerInput) currentSubProblemAnswerInput.value = '';
            
            const initialAnswerEl = document.getElementById('initialAnswerSection');
            const imageUploadEl = document.getElementById('imageUploadSection');
            if(initialAnswerEl) initialAnswerEl.style.display = 'block'; 
            if(imageUploadEl) imageUploadEl.style.display = 'block';

            if(checkAnswerButton) checkAnswerButton.disabled = false;
            if(checkSubStepButton) checkSubStepButton.disabled = false;
            if(currentSubProblemAnswerInput) currentSubProblemAnswerInput.disabled = false;
            hideProactiveTip(); 
        }

        // --- API Key & Settings ---
        function toggleSettingsMenu() { if(settingsMenu) settingsMenu.classList.toggle('expanded'); if(historyMenu && historyMenu.classList.contains('expanded')) historyMenu.classList.remove('expanded'); }
        function toggleHistoryMenu() { if(historyMenu) historyMenu.classList.toggle('expanded'); if(settingsMenu && settingsMenu.classList.contains('expanded')) settingsMenu.classList.remove('expanded');} 
        function loadApiKey() { 
            if (!apiKeyStatus || !apiKeyInput || !settingsMenu) {
                console.error("API Key UI elements missing in loadApiKey");
                return;
            }
            const storedKey = localStorage.getItem('geminiApiKey');
            if (storedKey) {
                geminiApiKey = storedKey;
                apiKeyInput.value = storedKey;
                apiKeyStatus.textContent = '驻转 API 注 爪!';
                apiKeyStatus.className = 'mt-2 text-sm text-center text-green-700';
                settingsMenu.classList.remove('expanded'); 
            } else {
                apiKeyStatus.textContent = '  转 驻转 -API 砖 砖 Gemini.';
                apiKeyStatus.className = 'mt-2 text-sm text-center text-red-700';
                settingsMenu.classList.add('expanded'); 
            }
            apiKeyStatus.classList.remove('hidden');
         }
        function saveApiKey() { /* ... same as v6 ... */ }

        // --- Dropdowns ---
        function populateDropdowns() { /* ... same as v6 ... */ }
        function populateYears() { /* ... same as v6 ... */ }
        function populateQuestions() { /* ... same as v6 ... */ }
        
        // --- Problem Loading ---
        function loadProblemFromSelection() { /* ... same as v6 ... */ }
        
        // --- Gemini API Call ---
        async function callGeminiAPI(promptText, isChatContext = false) { /* ... same as v6 ... */ }

        // --- Hint System ---
        async function getHint() { /* ... same as v6 ... */ }

        // --- Answer Processing ---
        async function processStudentInput() { /* ... same as v6, ensure addHistoryEntry is called appropriately ... */ }

        // --- Step-by-Step Guidance ---
        async function startStepByStepGuidance() { /* ... same as v6 ... */ }
        function extractContent(text, startMarker, endMarker) { /* ... same as v6 ... */ }
        async function checkSubStepAnswer() { /* ... same as v6 ... */ }
        function handleNextAfterSubStepFeedback(aiResponseText, lastUserSubStepAnswer) { /* ... same as v6, including addHistoryEntry on final correct step ... */ }
        
        // --- Modify Problem ---
        async function modifyProblem(modificationType) { /* ... same as v6 ... */ }

        // --- Chatbot & Tips ---
        function hideProactiveTip() { /* ... same as v6 ... */ }
        async function triggerProactiveTip() { /* ... same as v6 ... */ }
        function renderChatMessages() { /* ... same as v6 ... */ }
        async function sendChatMessage() { /* ... same as v6 ... */ }

        // --- Paste Image ---
        // Event listener moved to window.onload after pasteZone is defined

        // --- Whiteboard Functionality ---
        function resizeWhiteboardCanvas() {
            if (!whiteboardContainer || !whiteboardControls || !drawingBoard) {
                console.error("Whiteboard elements not ready for resize.");
                return;
            }
            const whiteboardContainerRect = whiteboardContainer.getBoundingClientRect();
            const controlsHeight = whiteboardControls.offsetHeight;
            const canvasContainerHeight = whiteboardContainerRect.height - controlsHeight - 32; 
            const canvasContainerWidth = whiteboardContainerRect.width - 32; 

            drawingBoard.width = canvasContainerWidth > 0 ? canvasContainerWidth : 300; 
            drawingBoard.height = canvasContainerHeight > 0 ? canvasContainerHeight : 200; 
            
            if (whiteboardCtx) { 
                whiteboardCtx.lineWidth = 3; // Increased line width for better visibility
                whiteboardCtx.lineCap = 'round';
                whiteboardCtx.strokeStyle = '#000000';
                console.log("Whiteboard canvas resized and context styles set.");
            }
        }

        function openWhiteboard() {
            if(whiteboardModal) whiteboardModal.classList.add('visible');
            if(document.body) document.body.style.overflow = 'hidden'; 
            resizeWhiteboardCanvas(); 
            clearWhiteboard(); 
            console.log("Whiteboard opened.");
            // Test draw
            if (whiteboardCtx) {
                whiteboardCtx.fillStyle = 'rgba(255, 0, 0, 0.5)'; // Semi-transparent red
                whiteboardCtx.fillRect(5, 5, 50, 25);
                console.log("Test rectangle drawn on whiteboard.");
            } else {
                console.error("Whiteboard context not available for test draw.");
            }
        }

        function closeWhiteboard() {
            if(whiteboardModal) whiteboardModal.classList.remove('visible');
            if(document.body) document.body.style.overflow = ''; 
            console.log("Whiteboard closed.");
        }

        function clearWhiteboard() {
            if(whiteboardCtx && drawingBoard) {
                whiteboardCtx.clearRect(0, 0, drawingBoard.width, drawingBoard.height);
                console.log("Whiteboard cleared.");
            }
        }

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (evt.clientX - rect.left) * scaleX,
                y: (evt.clientY - rect.top) * scaleY
            };
        }
        
        function getTouchPos(canvas, touch) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (touch.clientX - rect.left) * scaleX,
                y: (touch.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            if (!whiteboardCtx) { console.error("Cannot start drawing, whiteboard context is missing."); return; }
            isDrawingOnWhiteboard = true;
            let pos;
            if (e.type === 'touchstart') {
                pos = getTouchPos(drawingBoard, e.touches[0]);
                 e.preventDefault(); 
            } else {
                pos = getMousePos(drawingBoard, e);
            }
            [lastX, lastY] = [pos.x, pos.y]; 
            whiteboardCtx.beginPath(); 
            whiteboardCtx.moveTo(lastX, lastY); 
            console.log(`Start drawing at: ${lastX.toFixed(2)}, ${lastY.toFixed(2)}`);
        }

        function drawOnWhiteboard(e) {
            if (!isDrawingOnWhiteboard || !whiteboardCtx) return;
            let pos;
             if (e.type === 'touchmove') {
                pos = getTouchPos(drawingBoard, e.touches[0]);
                e.preventDefault(); 
            } else {
                pos = getMousePos(drawingBoard, e);
            }
            whiteboardCtx.lineTo(pos.x, pos.y); 
            whiteboardCtx.stroke(); 
            console.log(`Drawing to: ${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}`);
            [lastX, lastY] = [pos.x, pos.y]; 
        }

        function stopDrawing() {
            if (isDrawingOnWhiteboard && whiteboardCtx) {
                // whiteboardCtx.closePath(); // Not strictly necessary for freehand lines
                isDrawingOnWhiteboard = false;
                console.log("Stopped drawing.");
            }
        }

        async function saveWhiteboardAsImage() { /* ... same as v6 ... */ }
        
        // --- Event Listeners ---
        window.onload = function() {
            // Initialize DOM elements
            settingsButton = document.getElementById('settingsButton'); 
            historyButton = document.getElementById('historyButton'); 
            settingsMenu = document.getElementById('settingsMenu'); 
            historyMenu = document.getElementById('historyMenu'); 
            historyPanelContent = document.getElementById('historyPanelContent'); 
            exportCsvButton = document.getElementById('exportCsvButton'); 
            exportJsonButton = document.getElementById('exportJsonButton'); 
            getRecommendationsButton = document.getElementById('getRecommendationsButton'); 
            aiRecommendationsContent = document.getElementById('aiRecommendationsContent'); 
            getHintButton = document.getElementById('getHintButton'); 
            hintDisplay = document.getElementById('hintDisplay'); 
            apiKeyInput = document.getElementById('apiKeyInput');
            saveApiKeyButton = document.getElementById('saveApiKeyButton');
            apiKeyStatus = document.getElementById('apiKeyStatus');
            moduleSelect = document.getElementById('moduleSelect');
            yearSelect = document.getElementById('yearSelect');
            questionSelect = document.getElementById('questionSelect');
            loadProblemButton = document.getElementById('loadProblemButton');
            problemDisplaySection = document.getElementById('problemDisplaySection');
            studentAnswerInput = document.getElementById('studentAnswer');
            checkAnswerButton = document.getElementById('checkAnswerButton'); 
            checkAnswerResultDisplay = document.getElementById('checkAnswerResultDisplay');
            acknowledgeFeedbackButton = document.getElementById('acknowledgeFeedbackButton');
            stepByStepSection = document.getElementById('stepByStepSection');
            currentStepNumberSpan = document.getElementById('currentStepNumber');
            currentSubProblemQuestionDiv = document.getElementById('currentSubProblemQuestion');
            currentSubProblemAnswerInput = document.getElementById('currentSubProblemAnswer');
            checkSubStepButton = document.getElementById('checkSubStepButton');
            imageUploadInput = document.getElementById('imageUpload');
            pasteZone = document.getElementById('pasteZone'); 
            selectedImageName = document.getElementById('selectedImageName');
            simplifyProblemButton = document.getElementById('simplifyProblemButton');
            makeHarderProblemButton = document.getElementById('makeHarderProblemButton');
            loadingIndicator = document.getElementById('loadingIndicator');
            errorMessageDisplay = document.getElementById('errorMessageDisplay');
            errorMessageText = document.getElementById('errorMessageText');
            aiFeedbackDisplay = document.getElementById('aiFeedbackDisplay');
            aiFeedbackContent = document.getElementById('aiFeedbackContent');
            mathBotToggleContainer = document.getElementById('mathBotToggleContainer');
            mathBotToggle = document.getElementById('mathBotToggle');
            proactiveTipBubble = document.getElementById('proactiveTipBubble');
            mathBotContainer = document.getElementById('mathBotContainer');
            closeChatButton = document.getElementById('closeChatButton');
            chatMessagesDisplay = document.getElementById('chatMessagesDisplay');
            chatInput = document.getElementById('chatInput');
            sendChatMessageButton = document.getElementById('sendChatMessageButton');
            openWhiteboardButton = document.getElementById('openWhiteboardButton');
            whiteboardModal = document.getElementById('whiteboardModal');
            drawingBoard = document.getElementById('drawingBoard');
            saveWhiteboardButton = document.getElementById('saveWhiteboardButton');
            clearWhiteboardButton = document.getElementById('clearWhiteboardButton');
            closeWhiteboardButton = document.getElementById('closeWhiteboardButton');

            if (drawingBoard) {
                whiteboardCtx = drawingBoard.getContext('2d');
                 if (!whiteboardCtx) {
                    console.error("Failed to get 2D context for drawing board!");
                }
            } else {
                console.error("Drawing board element not found on load!");
            }

            loadApiKey(); 
            loadUserHistory(); 
            populateDropdowns();
            loadProblemFromSelection(); 

            if(settingsButton) settingsButton.addEventListener('click', toggleSettingsMenu); 
            if(historyButton) historyButton.addEventListener('click', toggleHistoryMenu); 
            if(getHintButton) getHintButton.addEventListener('click', getHint); 
            if(exportCsvButton) exportCsvButton.addEventListener('click', exportAsCsv); 
            if(exportJsonButton) exportJsonButton.addEventListener('click', exportAsJson); 
            if(getRecommendationsButton) getRecommendationsButton.addEventListener('click', getAIRecommendations); 
            if(openWhiteboardButton) openWhiteboardButton.addEventListener('click', openWhiteboard);
            if(closeWhiteboardButton) closeWhiteboardButton.addEventListener('click', closeWhiteboard);
            if(clearWhiteboardButton) clearWhiteboardButton.addEventListener('click', clearWhiteboard);
            if(saveWhiteboardButton) saveWhiteboardButton.addEventListener('click', saveWhiteboardAsImage);

            if (drawingBoard) {
                drawingBoard.addEventListener('mousedown', startDrawing);
                drawingBoard.addEventListener('mousemove', drawOnWhiteboard);
                drawingBoard.addEventListener('mouseup', stopDrawing);
                drawingBoard.addEventListener('mouseleave', stopDrawing); 
                drawingBoard.addEventListener('touchstart', startDrawing, { passive: false });
                drawingBoard.addEventListener('touchmove', drawOnWhiteboard, { passive: false });
                drawingBoard.addEventListener('touchend', stopDrawing);
                drawingBoard.addEventListener('touchcancel', stopDrawing);
            }
            
            window.addEventListener('resize', resizeWhiteboardCanvas); 

            if(moduleSelect) moduleSelect.addEventListener('change', () => { populateYears(); populateQuestions(); loadProblemFromSelection(); });
            if(yearSelect) yearSelect.addEventListener('change', () => { populateQuestions(); loadProblemFromSelection(); });
            if(questionSelect) questionSelect.addEventListener('change', loadProblemFromSelection);
            if(loadProblemButton) loadProblemButton.addEventListener('click', loadProblemFromSelection);
            if(checkAnswerButton) checkAnswerButton.addEventListener('click', processStudentInput); 
            if(checkSubStepButton) checkSubStepButton.addEventListener('click', checkSubStepAnswer);
            if(imageUploadInput) imageUploadInput.addEventListener('change', (e) => { 
                if (e.target.files && e.target.files[0]) {
                    if(selectedImageName) selectedImageName.textContent = `拽抓 专: ${e.target.files[0].name}`;
                    if(pasteZone) pasteZone.textContent = '拽抓 专. 转 拽 专 拽.';
                } else {
                    if(selectedImageName) selectedImageName.textContent = '';
                }
            });
            if(simplifyProblemButton) simplifyProblemButton.addEventListener('click', () => modifyProblem('simplify'));
            if(makeHarderProblemButton) makeHarderProblemButton.addEventListener('click', () => modifyProblem('makeHarder'));
            if(saveApiKeyButton) saveApiKeyButton.addEventListener('click', saveApiKey);
            if(mathBotToggle) mathBotToggle.addEventListener('click', () => {
                if(mathBotContainer) mathBotContainer.classList.toggle('expanded');
                if (mathBotContainer && mathBotContainer.classList.contains('expanded')) {
                    hideProactiveTip(); 
                    if(chatInput) chatInput.focus();
                }
            });
            if(closeChatButton) closeChatButton.addEventListener('click', () => {
                if(mathBotContainer) mathBotContainer.classList.remove('expanded');
            });
            if(sendChatMessageButton) sendChatMessageButton.addEventListener('click', sendChatMessage);
            if(chatInput) chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            if(pasteZone) pasteZone.addEventListener('paste', function(event) { 
                event.preventDefault(); 
                const items = (event.clipboardData || window.clipboardData).items;
                let imageFile = null;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        imageFile = items[i].getAsFile();
                        break;
                    }
                }
                if (imageFile && imageUploadInput && selectedImageName && pasteZone) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(imageFile);
                    imageUploadInput.files = dataTransfer.files;
                    selectedImageName.textContent = `拽抓 拽: ${imageFile.name}`;
                    pasteZone.textContent = '转 拽 爪!';
                    setTimeout(() => { 
                         pasteZone.textContent = ' 拽 爪 住  (Ctrl+V)';
                    }, 3000);
                } else if (selectedImageName && pasteZone) {
                    selectedImageName.textContent = '拽   转 拽转.';
                     pasteZone.textContent = ' 转 转 拽.';
                     setTimeout(() => {
                         pasteZone.textContent = ' 拽 爪 住  (Ctrl+V)';
                    }, 3000);
                }
            });
        };
    </script>
</body>
</html>
