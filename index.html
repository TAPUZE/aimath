<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专 转拽 AI 专转</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .math-problem-display p {
            margin-bottom: 0.5rem;
        }
        /* Basic styling for LaTeX-like display */
        .math-problem-display {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            text-align: center;
        }
        .math-problem-display span {
            font-family: 'Times New Roman', serif; /* Or a specific math font */
            font-style: italic;
        }
        .math-problem-display sub {
            vertical-align: sub;
            font-size: smaller;
        }
        .math-problem-display sup {
            vertical-align: super;
            font-size: smaller;
        }
        .math-problem-display .latex-formula {
            display: inline-block;
            font-family: 'KaTeX_Main', 'Times New Roman', serif; /* Placeholder for KaTeX font if it were loaded */
            font-size: 1.25em; /* Adjust as needed */
            line-height: 1;
            white-space: nowrap;
        }
        .latex-formula::before { content: '$'; }
        .latex-formula::after { content: '$'; }
        .rtl-text {
            direction: rtl;
            text-align: right;
        }
        .chat-message-user {
            background-color: #DBEAFE; /* blue-100 */
            align-self: flex-end;
            text-align: right;
            border-radius: 0.75rem 0.75rem 0.25rem 0.75rem; /* rounded-xl rounded-bl-sm */
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }
        .chat-message-ai {
            background-color: #EDE9FE; /* purple-100 */
            align-self: flex-start;
            text-align: right; /* Changed to right for RTL */
            border-radius: 0.75rem 0.75rem 0.75rem 0.25rem; /* rounded-xl rounded-br-sm */
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-8 flex flex-col items-center font-sans text-gray-800">

    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200 rtl-text">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-700 mb-6">
            专 转拽 AI 专转
        </h1>

        <div class="bg-gray-100 rounded-lg p-5 mb-6 border border-gray-300">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-3 text-center">
                专转 驻转 API 砖 Gemini
            </h2>
            <p class="text-sm text-gray-600 mb-3 text-center">
                  转 驻转 -API 砖 砖 Gemini.  砖专 住 拽 砖 驻驻 砖.
            </p>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="password" id="apiKeyInput" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder=" 转 驻转 -API ...">
                <button id="saveApiKeyButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    砖专 驻转 API
                </button>
            </div>
            <p id="apiKeyStatus" class="mt-2 text-sm text-center text-green-700 hidden"></p>
        </div>

        <div class="bg-gray-50 rounded-lg p-5 mb-6 border border-gray-200">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-3 text-center">
                专 砖转 专转
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="moduleSelect" class="block text-sm font-medium text-gray-700 mb-1">
                        :
                    </label>
                    <select id="moduleSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </select>
                </div>
                <div>
                    <label for="yearSelect" class="block text-sm font-medium text-gray-700 mb-1">
                        砖:
                    </label>
                    <select id="yearSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </select>
                </div>
                <div>
                    <label for="questionSelect" class="block text-sm font-medium text-gray-700 mb-1">
                        砖:
                    </label>
                    <select id="questionSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </select>
                </div>
            </div>
            <button id="loadProblemButton" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                注 砖 专转
            </button>
        </div>

        <div id="problemDisplaySection" class="bg-blue-50 rounded-lg p-5 mb-6 border border-blue-200">
            </div>

        <div id="initialAnswerSection" class="mb-6">
            <label for="studentAnswer" class="block text-lg font-medium text-gray-700 mb-2">
                转砖 砖 (拽 驻砖转):
            </label>
            <textarea id="studentAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out resize-y min-h-[80px]" rows="4" placeholder="拽 转 转砖转 转 砖 驻转专 ..."></textarea>
            <button id="checkAnswerButton" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                拽 转砖
            </button>
        </div>

        <div id="checkAnswerResultDisplay" class="p-4 rounded-lg mb-6 text-center font-semibold text-lg hidden">
            </div>

        <div id="stepByStepSection" class="bg-yellow-50 rounded-lg p-5 mb-6 border border-yellow-200 hidden">
            <h2 class="text-xl sm:text-2xl font-semibold text-yellow-800 mb-3 text-center">
                砖 专 砖: 砖 <span id="currentStepNumber">1</span>
            </h2>
            <div id="currentSubProblemQuestion" class="math-problem-display text-xl font-semibold text-center leading-relaxed mb-4">
                </div>
            <label for="currentSubProblemAnswer" class="block text-lg font-medium text-gray-700 mb-2">
                转砖转 砖 :
            </label>
            <textarea id="currentSubProblemAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out resize-y min-h-[60px]" rows="3" placeholder="拽 转 转砖转 砖 ..."></textarea>
            <button id="checkSubStepButton" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                拽 砖
            </button>
        </div>

        <div class="mb-6">
            <label for="imageUpload" class="block text-lg font-medium text-gray-700 mb-2">
                注 注转  (驻爪 拽转 砖 AI):
            </label>
            <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            <p id="selectedImageName" class="mt-2 text-sm text-gray-600"></p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <button id="simplifyProblemButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                驻砖 注
            </button>
            <button id="makeHarderProblemButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                驻 注 拽砖 转专
            </button>
        </div>
        <button id="getAIFeedbackOnUploadButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 mb-6">
            拽 砖 AI (注 注 砖注转)
        </button>

        <div id="loadingIndicator" class="flex items-center justify-center mb-4 text-indigo-600 hidden">
            <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            注...
        </div>
        <div id="errorMessageDisplay" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert">
            <strong class="font-bold">砖!</strong>
            <span id="errorMessageText" class="block sm:inline"></span>
        </div>

        <div id="aiFeedbackDisplay" class="bg-purple-50 rounded-lg p-5 border border-purple-200 mt-6 hidden">
            <h2 class="text-xl sm:text-2xl font-semibold text-purple-800 mb-3 text-center">
                砖 AI
            </h2>
            <div id="aiFeedbackContent" class="text-gray-700 leading-relaxed">
                </div>
        </div>

        <div class="bg-gray-50 rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200 mt-8">
            <h2 class="text-2xl sm:text-3xl font-bold text-center text-green-700 mb-6">
                爪' 转 注 AI
            </h2>
            <div id="chatMessagesDisplay" class="flex flex-col h-96 bg-white border border-gray-300 rounded-lg p-4 overflow-y-auto mb-4">
                </div>
            <div class="flex">
                <textarea id="chatInput" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200 ease-in-out resize-none" rows="2" placeholder="砖 砖 转转..."></textarea>
                <button id="sendChatMessageButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-r-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    砖
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-2 text-center">
                砖转砖 爪'   砖 砖转 转转 转  拽砖 注专 爪注 专 爪注 驻转专 注转.
            </p>
        </div>
    </div>

    <script>
        // Global state variables
        let geminiApiKey = ''; // Stores the API key
        let currentProblem = null;
        let isLoading = false;
        let errorMessage = '';
        let checkAnswerResult = null; // 'correct', 'incorrect', null

        let isInStepByStepMode = false;
        let currentStepIndex = 0;
        let stepByStepHistory = []; // Stores { user_answer, ai_response_html_question } for steps
        let currentSubProblemQuestion = '';
        let currentSubProblemAnswer = '';

        let chatMessages = []; // Stores { sender: 'user'/'ai', text: '...' }
        let isChatLoading = false;

        // DOM Elements
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');
        const apiKeyStatus = document.getElementById('apiKeyStatus');

        const moduleSelect = document.getElementById('moduleSelect');
        const yearSelect = document.getElementById('yearSelect');
        const questionSelect = document.getElementById('questionSelect');
        const loadProblemButton = document.getElementById('loadProblemButton');
        const problemDisplaySection = document.getElementById('problemDisplaySection');
        const studentAnswerInput = document.getElementById('studentAnswer');
        const checkAnswerButton = document.getElementById('checkAnswerButton');
        const checkAnswerResultDisplay = document.getElementById('checkAnswerResultDisplay');
        const stepByStepSection = document.getElementById('stepByStepSection');
        const currentStepNumberSpan = document.getElementById('currentStepNumber');
        const currentSubProblemQuestionDiv = document.getElementById('currentSubProblemQuestion');
        const currentSubProblemAnswerInput = document.getElementById('currentSubProblemAnswer');
        const checkSubStepButton = document.getElementById('checkSubStepButton');
        const imageUploadInput = document.getElementById('imageUpload');
        const selectedImageName = document.getElementById('selectedImageName');
        const simplifyProblemButton = document.getElementById('simplifyProblemButton');
        const makeHarderProblemButton = document.getElementById('makeHarderProblemButton');
        const getAIFeedbackOnUploadButton = document.getElementById('getAIFeedbackOnUploadButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageDisplay = document.getElementById('errorMessageDisplay');
        const errorMessageText = document.getElementById('errorMessageText');
        const aiFeedbackDisplay = document.getElementById('aiFeedbackDisplay');
        const aiFeedbackContent = document.getElementById('aiFeedbackContent');
        const chatMessagesDisplay = document.getElementById('chatMessagesDisplay');
        const chatInput = document.getElementById('chatInput');
        const sendChatMessageButton = document.getElementById('sendChatMessageButton');

        // Bagrut questions data (same as React version)
        const bagrutQuestionsData = {
            '801': {
                '2025': [
                    { id: '801-2025-1', question: "砖专转 砖  转   砖专转 砖  志 1,740 砖拽. 砖专转 砖  注转 志15%, 砖专转 砖  砖专  砖. 专 注 转 砖专转 砖  砖 砖专转 砖 . 住  x 转 砖专转 砖  驻 注. . 注 爪注转 x 转 砖专转 砖 . . 爪 转 砖专转 砖  驻 注.", answer: "砖专转 : $x+1740$; 砖专转 : 11600 砖拽", topic: "专 - 注转 转", difficulty: "拽", mikud: false, imageUrl: null },
                    { id: '801-2025-2', question: "  专 砖专  转 专 注专 转 驻专转.    砖 :  I   II.  I 转砖  转  ,  60 砖拽 .  II 转砖 转  , 驻 砖注转. 专祝 砖驻 转专 转 拽砖专  住驻专 砖注转   转砖 注专   II.  专砖  专 砖专  II 砖注 9:00 拽专, 注 转  砖注 13:00 爪专. .  砖 专 砖专 注专   专砖? .  砖 转 专 砖专 砖专 专 注专 8 砖注转,    转  砖 转砖 注专  砖 8 砖注转  转专.  砖 专 砖专 注专  转? .  砖注转  转专  专 砖专 转,  砖  50 砖拽 ?", answer: "45 砖拽; 60 砖拽; 6 砖注转", topic: "专驻 驻拽爪转", difficulty: "", mikud: true, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=专祝++II" },
                    { id: '801-2025-3', question: "住专 砖转 专 砖砖  4, 专 砖  9. . (1) 爪 转 驻专砖 住专. (2) 爪 转 专 专砖 住专. 专 专 住专  39. . 爪 转 住驻专 专 住专. . 爪 转 住  专 住专.", answer: "d=2.5, a1=-1; n=16; S_n=304", topic: "住专转 砖转", difficulty: "", mikud: false, imageUrl: null },
                    { id: '801-2025-4', question: "住专 砖驻 转专转 拽转 ABCD. 砖转 住 AC  $y=0.5x+2$. 拽拽 A 志D 爪 注 爪专 志 x, 转专 住专. . 爪 转 砖注专 拽拽 A. 转 $B(1,6)$. . (1)  砖注专 志 y 砖 拽拽 C? (2) 爪 转 砖注专 志 x 砖 拽拽 C. . (1) 爪 转 专 爪注 BC. (2) 爪 转 砖注专 拽拽 D. . 爪 转 拽祝 拽转 ABCD.", answer: "A(-4,0); C(10,7); BC=5, D(5,1); 拽祝: $10+2\\sqrt{37}$", topic: "专 转", difficulty: "拽砖", mikud: true, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=拽转+ABCD" },
                    { id: '801-2025-5', question: "砖砖 ABC  砖 砖拽 $AB=AC$. BD   砖拽 AC. 专 住住 BC  12.  转 住住  $65^{\\circ}$. . 爪 转 专  BD. . (1)   转 专砖 BAC ? (2) 爪 转 专 砖拽 AB.", answer: "BD=10.87; 转 专砖: $50^{\\circ}$; AB=14.18", topic: "专专", difficulty: "", mikud: false, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=砖砖+砖+砖拽" },
                    { id: '801-2025-6', question: "  5 专 砖专, 7 专  志 8 专 . 爪   拽专 专 , 专 转 , 砖 爪 拽专 专 . .  住转专转 砖砖 专 砖爪  ? .  住转专转 砖砖 专 砖爪  转 爪注? .  住转专转 砖转 爪 专 砖专 专  专 ? .  住转专转 砖 砖 专 砖爪  砖专   ?", answer: ". $(7/20)^2 = 49/400$; . $(5/20)^2 + (7/20)^2 + (8/20)^2 = 25/400 + 49/400 + 64/400 = 138/400$; . $(5/20) * (8/20) = 40/400$; . $2 * (5/20) * (8/20) = 80/400$", topic: "住转专转", difficulty: "", mikud: false, imageUrl: null }
                ],
                '2023': [ /* ... existing simulated data ... */ ],
                '2022': [ /* ... existing simulated data ... */ ],
                '2021': [ /* ... existing simulated data ... */ ],
                '2020': [ /* ... existing simulated data ... */ ],
                '2019': [ /* ... existing simulated data ... */ ]
            },
            '802': {
                '2025': [
                    { id: '802-2025-1', question: "转 驻专 砖砖转 $y=-4x^{2}+28x-33$. A  B  拽转 转 砖 驻专 注 爪专 志 x, 转专 住专. . 爪 转 砖注专 拽转 A 志B. 拽 C  拽拽 驻专. . 爪 转 砖注专 拽 C. . 砖 转 砖 砖砖 ABC. . (1) 转 注专 砖 砖 x 拽 砖 驻专 砖转. (2) 爪 转 砖注专 志 y 砖 拽 .", answer: "A(1.5,0), B(5.5,0); C(3.5,16); 砖 ABC: 32 \"专; . (1) x=0, (2) y=-33", topic: "专 - 驻专", difficulty: "", mikud: false, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=驻专" },
                    { id: '802-2025-2', question: "专 拽专 住驻专 住. 住驻专 注 砖 拽专     住驻专 拽注 住驻专 注 砖 拽专  砖驻.  砖 拽专 专 14 注,  砖注  拽专 59 注. . 爪   住驻专 注 砖专 拽专   住驻专 注 砖 拽专  砖驻. . 爪  注 拽专 专  专砖. 专 住 拽专 转  住驻专 专 12  拽. . 爪  注 砖 住驻专. 砖  专爪驻 拽专 专 91 注 住 . . 爪   拽专 专 住驻专 注 .", answer: ". 9 注; . 5 注; . 678 注; .  5 -6", topic: "住专转 砖转 - 注转 转", difficulty: "", mikud: false, imageUrl: null },
                    { id: '802-2025-3', question: "专 砖 转 住驻转   砖  拽注, 专 砖 转 砖驻转转 拽  砖  拽注. 专驻 II-I 砖驻 转专 转 专 砖  转  转, 驻 砖. . 注 驻 专驻,  转转 砖转 2010  专 砖 转 住驻转  转专  专 砖 转 砖驻转转? 转转 砖转 2010  专 砖 转 住驻转 40,000 砖拽, 转转 砖转 2012  专 42,436 砖拽. . (1) 爪    专 砖 转 住驻转  砖. (2) 爪   专 砖 转 住驻转 转转 砖转 2016. 转转 砖转 2016  专 砖 砖转 转 . 专 砖 转 砖驻转转 拽  砖 - 15%.  住 住祝 拽转 转. 转转 砖转 2017   41,000 砖拽. .  转转 砖    拽转 转 转 砖驻转转? 拽 转 转砖转.", answer: ". ; . (1) 3%, (2) 50597.05 砖拽; . , 专  42997.5 砖拽", topic: " 注", difficulty: "拽砖", mikud: true, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=专祝+转" },
                    { id: '802-2025-4', question: "专驻 砖 砖拽 (ABDC) ABCD, DE   住住 AB (专 住专). 转 $AD=28$, $DE=26$. . 爪 转 专 拽注 AE. . 爪 转  转 DAE. . 住 专驻 BD  砖拽 AD. (1) 爪 转 专 住住 AB. (2) 爪 转 专 住住 CD. . 砖 转 砖 专驻 ABCD.", answer: ". $AE = \\sqrt{28^2 - 26^2} = \\sqrt{784 - 676} = \\sqrt{108} \\approx 10.39$; . $DAE = \\arcsin(26/28) \\approx 68.21^{\\circ}$; . (1) AB = 38.64, (2) CD = 17.86; . 砖 = 734.48", topic: "专专", difficulty: "拽砖", mikud: false, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=专驻+ABCD" },
                    { id: '802-2025-5', question: " 砖 砖拽 拽注 专 拽 专注 专.  专 专砖 住驻专 拽转 砖   拽注 专  (专 住专). 专转 拽注转 专  . 住转专转 砖专转 转拽注 专 砖专砖  100  $\\frac{1}{2}$. 住转专转 砖专转 转拽注    专 砖专砖  40, 60  80  , 砖 志 $\\frac{1}{6}$. . 专转 拽注 专 驻注 转.  住转专转 砖专转 转 志 80 拽转  转专? 专转 拽注 专 驻注. .  住转专转 砖 转 砖转 驻注 转 专转 志 40 拽转? .  住转专转 砖砖转 驻注 转 专转 转 住驻专 拽转? .  住转专转 砖住 拽转 砖转  专转 砖转 驻注 砖 志 160 ?", answer: ". $1/2 + 1/6 = 2/3$; . $(1/6)^2 = 1/36$; . $(1/2)^2 + 3 * (1/6)^2 = 1/4 + 3/36 = 1/4 + 1/12 = 4/12 = 1/3$; . $2 * (60/100) + 2 * (80/80) = 2 * (1/6) * (1/6) + (1/6) * (1/6) = 2/36 + 1/36 = 3/36 = 1/12$", topic: "住转专转", difficulty: "", mikud: false, imageUrl: "https://placehold.co/200x200/E0F2F7/000000?text=+拽注" },
                    { id: '802-2025-6', question: "爪  专爪 转拽 转驻 专转, 爪注  71. 爪 砖 7%    志 83. . 爪 转 住转 转拽 砖 爪. . 爪 转   砖爪 砖   55 志 75. 转: 爪 砖 4,891    $75\\rightarrow55$. . 注 驻 专祝 转驻转 专转,   砖  专爪? 16%  ,  砖爪 砖   转专,  转专 . .   砖爪 砖  65  转专 ? 拽 转 转砖转. 驻 专祝 转驻转 专转 祝 住转. 砖转砖  砖.", answer: ". 住转 转拽: 8; . 68%; . 7192.64; . ,  65 爪 注 -16%  转专 (71-8=63),    ", topic: "住住拽 - 转驻转 专转", difficulty: "拽砖", mikud: true, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=转驻转+专转" }
                ],
                '2023': [ /* ... existing simulated data ... */ ],
                '2022': [ /* ... existing simulated data ... */ ],
                '2021': [ /* ... existing simulated data ... */ ],
                '2020': [ /* ... existing simulated data ... */ ],
                '2019': [ /* ... existing simulated data ... */ ]
            },
            '803': {
                '2025': [
                    { id: '803-2025-1', question: "转  住转 专 砖 注  - 72 砖拽  专 砖 爪. 转 专 注 爪注 砖 15%  注 专 砖 爪 (专 砖 注  砖转). 专 砖 爪 转 爪注 砖 注   175.6 砖拽 住 . . (1) 爪 转 专 砖 爪 驻 . (2) 爪 转 专 砖 爪 爪注. 拽专转  砖 砖转 \", 拽转 专转 转 60 驻专: 拽 注 砖专 爪转 爪注.  砖 4,383.6 砖拽 住 . . 爪 转 住驻专 爪转 砖拽转 专转.  拽 转 4 注. 砖专 注  拽驻  砖, 转专专  砖   注 专 砖 注,  砖 专 注.  砖 448 砖拽 住 . . 爪 转   砖拽  注 专 注.", answer: "爪 驻 : 68 砖拽, 爪 爪注: 57.8 砖拽; 36 爪转; 20% ", topic: "专 - 注转 转", difficulty: "", mikud: false, imageUrl: null },
                    { id: '803-2025-2', question: "砖砖 砖专 转 $(\\sphericalangle ACB=90^{\\circ})$ ABC, 拽拽 B 爪 注 爪专 志 y, 爪注 AB 转转 转 爪专 志 x 拽 D. 转  砖转 爪注 AB  $y=-\\frac{1}{2}x+6$. . 爪 转 砖注专 拽转 B 志D. 拽 D  爪注 爪注 AB. . 爪 转 砖注专 拽拽 A. 转  砖转 爪注 BC  $y=\\frac{1}{3}x+6$. . (1) 爪 转 砖转 爪注 AC. (2) 爪 转 砖注专 拽拽 C. 转  $K(0,-15)$. . (1) 砖 转 砖 砖砖 ABC. (2) 砖 转 砖 专注 BCAK.", answer: "B(0,6), D(12,0); A(24,-6); AC: $y=x-30$, C(18,12); 砖 ABC: 90 \"专, 砖 BCAK: 126 \"专", topic: "专 转", difficulty: "拽砖", mikud: true, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=砖砖+ABC" },
                    { id: '803-2025-3', question: "转 注 砖专 M 砖转 $(x-14)^{2}+(y-10)^{2}=117$. 拽转 B 志C 爪转 注 注  砖志 BC  拽专 注, 转专 住专. 转: 砖注专 志 x 砖 拽 C  23. .   砖注专 拽 M ? . (1) 爪 转 砖注专 拽 C (砖注专 志 y 砖 拽 C 拽 志10). (2) 爪 转 砖注专 拽 B. 砖专 AB 砖拽 注 拽 B. . (1) 爪 转 砖驻注 砖专 BM. (2) 爪 转 砖转 砖专 AB. 转  砖专 AC 拽 爪专 志 x. . 爪 转 砖注专 拽 A . . 爪 转 拽祝 砖砖 AMC .", answer: "M(14,10); C(23,1), B(5,19); 砖驻注 BM: -9/9 = -1, AB: $y-19=1(x-5) \\Rightarrow y=x+14$; A(14,1); 拽祝 AMC: $9\\sqrt{2}+18$", topic: "专 转 - 注", difficulty: "拽砖", mikud: true, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=注+M" },
                    { id: '803-2025-4', question: "住专 砖驻 转专 专祝 驻拽爪 $.f(x)=\\frac{48}{x}+3x-30$. . 爪 转 转 专 砖 驻拽爪 $f(x)$. . 爪 转 砖注专 拽转 拽爪 砖 驻拽爪 $f(x)$, 拽注 转 住 注 驻 专祝. . 爪 转 转 注 砖 驻拽爪 $f(x)$. . 驻 砖转 注转 II-I. 拽注 注专  注      . 拽 转 拽注转. I. 专祝 驻拽爪 $f(x)$ 转 转 爪专 志 拽 砖 $x=2$. II. 拽 砖 $x=3$ 驻拽爪 $f(x)$ 转.", answer: "转 专: $x \\ne 0$; 拽爪: $(4,-6)$ , $(-4,-54)$ 拽住; 注: $x<-4$  $x>4$; 注 I:  , 注 II: ", topic: "砖 驻专爪 - 拽专转 驻拽爪", difficulty: "", mikud: false, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=专祝+驻拽爪" },
                    { id: '803-2025-5', question: "转 驻拽爪 $f(x)=x^{3}-9x^{2}+15x+27$. 拽转 $B^{-}A$  拽转 拽爪 砖 驻拽爪 $f(x)$, 转专 住专. . 爪 转 砖注专 拽转 A 志B. . 爪 转 砖转 砖拽 专祝 驻拽爪 $f(x)$ 拽转  砖. . 砖 转 砖 拽拽 住专: 砖  注  专祝 驻拽爪 (f(x, 注  砖拽 注  爪专 志y.", answer: "A(1,34) 拽住, B(5,2) ; 砖拽: $y=2$; 砖: 13.5 \"专", topic: "砖 驻专爪 专", difficulty: "拽砖", mikud: true, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=专祝+驻拽爪+拽爪" },
                    { id: '803-2025-6', question: " ABCD 专 爪注 BC  驻 2 专 爪注 DC. 注   专注 DEFG  砖拽拽 G 爪 注 爪注 AD (专 住专). 转 $CE=15$. 住  x 转 专 爪注 DC. . (1) 注 爪注转 x 转 专 爪注 BC 转 专 爪注 DE. (2) 注 爪注转 x 转 砖 专注 DEFG. . 爪 转 注专 砖 x 砖注专 住 砖 砖 专注 砖   . . 爪 转 住 砖 砖 专注 砖  注专 注专 砖 x 砖爪转 住注祝 .", answer: "BC=2x, DE=2x; 砖 专注: $4x^2$; x=3; 住 砖: 135", topic: "注转 拽爪", difficulty: "拽砖", mikud: false, imageUrl: "https://placehold.co/400x250/E0F2F7/000000?text=+专注" }
                ],
                '2023': [ /* ... existing simulated data ... */ ],
                '2022': [ /* ... existing simulated data ... */ ],
                '2021': [ /* ... existing simulated data ... */ ],
                '2020': [ /* ... existing simulated data ... */ ],
                '2019': [ /* ... existing simulated data ... */ ]
            }
        };

        // Function to populate dropdowns
        function populateDropdowns() {
            // Populate Module Select
            for (const module in bagrutQuestionsData) {
                const option = document.createElement('option');
                option.value = module;
                option.textContent = module;
                moduleSelect.appendChild(option);
            }

            // Set initial selected module and populate years/questions
            moduleSelect.value = '801'; // Default
            populateYears();
            populateQuestions();
        }

        // Function to populate years based on selected module
        function populateYears() {
            yearSelect.innerHTML = ''; // Clear existing options
            const selectedModule = moduleSelect.value;
            const years = Object.keys(bagrutQuestionsData[selectedModule] || {}).sort((a, b) => b - a);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            yearSelect.value = years[0]; // Select the latest year by default
        }

        // Function to populate questions based on selected module and year
        function populateQuestions() {
            questionSelect.innerHTML = ''; // Clear existing options
            for (let i = 1; i <= 6; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `砖 ${i}`;
                questionSelect.appendChild(option);
            }
            questionSelect.value = 1; // Default to question 1
        }

        // Function to display error message
        function showErrorMessage(message) {
            errorMessageText.textContent = message;
            errorMessageDisplay.classList.remove('hidden');
        }

        // Function to hide error message
        function hideErrorMessage() {
            errorMessageDisplay.classList.add('hidden');
            errorMessageText.textContent = '';
        }

        // Function to show/hide loading indicator
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Function to load a specific problem based on selected module, year, and question number
        async function loadProblemFromIndex() {
            hideErrorMessage();
            showLoading(true);
            aiFeedbackContent.innerHTML = '';
            aiFeedbackDisplay.classList.add('hidden');
            checkAnswerResultDisplay.classList.add('hidden');
            studentAnswerInput.value = '';
            imageUploadInput.value = '';
            selectedImageName.textContent = '';
            chatMessages = [];
            renderChatMessages();
            isInStepByStepMode = false;
            stepByStepSection.classList.add('hidden');
            document.getElementById('initialAnswerSection').classList.remove('hidden');


            const module = moduleSelect.value;
            const year = yearSelect.value;
            const questionNum = parseInt(questionSelect.value);

            const problem = bagrutQuestionsData[module]?.[year]?.[questionNum - 1];

            if (problem) {
                currentProblem = problem;
                let problemHtml = `
                    <h2 class="text-xl sm:text-2xl font-semibold text-blue-800 mb-3 text-center">
                        砖 转 (${currentProblem.difficulty} ${currentProblem.mikud ? '(拽)' : ''})
                    </h2>
                    <div class="math-problem-display text-xl font-semibold text-center leading-relaxed">
                        ${currentProblem.question.replace(/\$(.*?)\$/g, '<span class="latex-formula">$1</span>')}
                    </div>
                `;
                if (currentProblem.imageUrl) {
                    problemHtml += `
                        <div class="mt-4 text-center">
                            <img src="${currentProblem.imageUrl}" alt="转专砖 砖" class="mx-auto rounded-lg shadow-md max-w-full h-auto" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/000000?text=转专砖++';">
                            <p class="text-sm text-gray-600 mt-2">
                                ( 注 转专砖 拽专 砖 专转 注 拽 )
                            </p>
                        </div>
                    `;
                }
                problemDisplaySection.innerHTML = problemHtml;
            } else {
                currentProblem = null;
                problemDisplaySection.innerHTML = `
                    <div class="bg-yellow-50 rounded-lg p-5 text-yellow-800 text-center">
                         专 砖 拽住 注.
                    </div>
                `;
                showErrorMessage('Problem not found for the selected criteria.');
            }
            showLoading(false);
        }

        // Function to check the student's typed answer using AI
        async function checkTypedAnswer() {
            if (!geminiApiKey) {
                showErrorMessage('  砖专 转 驻转 -API 砖 Gemini 驻 砖砖 转转 AI.');
                return;
            }
            if (!currentProblem || studentAnswerInput.value.trim() === '') {
                showErrorMessage(' 专 砖 拽 转砖.');
                return;
            }

            showLoading(true);
            hideErrorMessage();
            aiFeedbackContent.innerHTML = '';
            aiFeedbackDisplay.classList.add('hidden');
            checkAnswerResultDisplay.classList.add('hidden');
            isInStepByStepMode = false;
            currentStepIndex = 0;
            stepByStepHistory = [];
            currentSubProblemQuestion = '';
            currentSubProblemAnswerInput.value = '';
            stepByStepSection.classList.add('hidden');
            document.getElementById('initialAnswerSection').classList.remove('hidden');


            try {
                const prompt = `转 专 转拽  转 专转 3 转 砖专.
                砖 : "${currentProblem.question}"
                转砖 砖转 砖 : "${studentAnswerInput.value}".

                 拽注 ****  转砖 砖砖   砖.
                转砖 砖 爪专 转 转 砖转  : ""  "砖".`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = geminiApiKey; // Use the saved API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText} - Body: ${errorBody}`);
                }

                const result = await response.json();
                let aiEvaluation = '';
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    aiEvaluation = result.candidates[0].content.parts[0].text.trim().toLowerCase();
                } else {
                    showErrorMessage('Failed to get AI evaluation. Please try again.');
                    console.error('Unexpected AI evaluation response structure:', result);
                    showLoading(false);
                    return;
                }

                if (aiEvaluation === '') {
                    checkAnswerResult = 'correct';
                    checkAnswerResultDisplay.className = 'p-4 rounded-lg mb-6 text-center font-semibold text-lg bg-green-100 text-green-700 border border-green-400';
                    checkAnswerResultDisplay.innerHTML = `
                         ! 转砖 ! 
                        <button id="loadNewProblemBtn" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                            注 砖 砖
                        </button>
                    `;
                    document.getElementById('loadNewProblemBtn').addEventListener('click', loadProblemFromIndex);
                    aiFeedbackContent.innerHTML = '';
                    aiFeedbackDisplay.classList.add('hidden');
                } else {
                    checkAnswerResult = 'incorrect';
                    checkAnswerResultDisplay.className = 'p-4 rounded-lg mb-6 text-center font-semibold text-lg bg-red-100 text-red-700 border border-red-400';
                    checkAnswerResultDisplay.innerHTML = '转砖 砖.  转 专 砖 专 砖  注专  . ';
                    isInStepByStepMode = true;
                    document.getElementById('initialAnswerSection').classList.add('hidden');
                    stepByStepSection.classList.remove('hidden');
                    await startStepByStepGuidance();
                }
                checkAnswerResultDisplay.classList.remove('hidden');
            } catch (error) {
                showErrorMessage(`砖 拽转 转砖: ${error.message}.  住 砖.`);
                console.error('Error in checkTypedAnswer:', error);
            } finally {
                showLoading(false);
            }
        }

        // Function to start the interactive step-by-step guidance
        async function startStepByStepGuidance() {
            if (!geminiApiKey) {
                showErrorMessage('  砖专 转 驻转 -API 砖 Gemini 驻 砖砖 转转 AI.');
                return;
            }
            if (!currentProblem) return;

            showLoading(true);
            hideErrorMessage();
            aiFeedbackContent.innerHTML = ''; // Clear previous feedback
            aiFeedbackDisplay.classList.add('hidden');
            currentStepIndex = 0;
            stepByStepHistory = [];
            currentSubProblemAnswerInput.value = '';
            currentStepNumberSpan.textContent = currentStepIndex + 1;


            const problemText = currentProblem.question;

            const prompt = `转 专 转拽 , 驻 专转拽 转 专转 3 转 砖专.
            注 拽专转 : "${problemText}".
            转 砖 转砖 砖 砖 .

             驻专拽 转 注 拽专转 拽 拽 专专. 爪  转 砖 专砖  砖 拽爪专 砖转 爪专 驻转专.
            砖转砖 驻专 HTML 注专 转砖 砖, 注 转 \`<h3>\` 转专转 砖 -\`<p>\` 砖.
            砖转砖 -LaTeX 注专  转, 注祝 专  (\`$\`)  驻 (\`$$\`) 注专 转爪 拽转.
            `;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = geminiApiKey; // Use the saved API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText} - Body: ${errorBody}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;
                    currentSubProblemQuestionDiv.innerHTML = aiResponseText.replace(/\$(.*?)\$/g, '<span class="latex-formula">$1</span>');
                    currentSubProblemQuestion = aiResponseText; // Store for next prompt
                    aiFeedbackDisplay.classList.remove('hidden'); // Show feedback display
                    aiFeedbackContent.innerHTML = aiResponseText.replace(/\$(.*?)\$/g, '<span class="latex-formula">$1</span>');
                } else {
                    showErrorMessage(' 转拽砖 转 专 砖 专 砖.  住 砖 专 转专.');
                    console.error('Unexpected AI step-by-step response structure:', result);
                }
            } catch (error) {
                showErrorMessage(`专注 砖 转转 专: ${error.message}.  住 砖.`);
                console.error('Error in startStepByStepGuidance:', error);
            } finally {
                showLoading(false);
            }
        }

        // Function to check the student's answer for the current sub-step
        async function checkSubStepAnswer() {
            if (!geminiApiKey) {
                showErrorMessage('  砖专 转 驻转 -API 砖 Gemini 驻 砖砖 转转 AI.');
                return;
            }
            if (!currentProblem || currentSubProblemAnswerInput.value.trim() === '') {
                showErrorMessage(' 拽 转砖 砖 .');
                return;
            }

            showLoading(true);
            hideErrorMessage();
            aiFeedbackContent.innerHTML = ''; // Clear previous feedback for the new step's feedback
            aiFeedbackDisplay.classList.add('hidden');


            const problemText = currentProblem.question;
            const previousStepsContext = stepByStepHistory.map((item, idx) => `砖 ${idx + 1} (砖): ${item.ai_response_html_question} 砖 ${idx + 1} (转砖转 转): ${item.user_answer}`).join('\n');

            const prompt = `转 专 转拽 , 驻 专转拽 转 专转 3 转 砖专.
            注 拽专转 : "${problemText}".
            专注  砖 ${currentStepIndex + 1} 砖 专 爪注 专 爪注.
            砖 砖  转: "${currentSubProblemQuestion}".
            转砖 砖 转 砖  : "${currentSubProblemAnswerInput.value}".

            ${previousStepsContext ? `住专转 砖 拽: ${previousStepsContext}` : ''}

             拽注  转砖 砖 转 砖 **** .
             转砖 :
            1.  住驻拽 拽  拽爪专.
            2.  爪 转 砖  驻转专 注 拽专转 砖 砖 砖转 爪专 驻转专.
            3.     砖 专, 住 转 驻转专  专 转 转.

             转砖  :
            1.  住驻拽 砖 拽  注转 住驻爪驻转 砖 .
            2.   转 转 住转 砖 转 转 砖,  注 专 拽爪专  砖 .

            砖转砖 驻专 HTML 注专 转砖 砖, 注 转 \`<h3>\` 转专转, \`<p>\` 驻住拽转, \`<ul>\` -\`<li>\` 专砖转, -\`<strong>\` 拽住 砖.
            砖转砖 -LaTeX 注专  转, 注祝 专  (\`$\`)  驻 (\`$$\`) 注专 转爪 拽转.
            `;

            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = geminiApiKey; // Use the saved API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText} - Body: ${errorBody}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;

                    // Store current step's interaction before processing next
                    stepByStepHistory.push({
                        user_answer: currentSubProblemAnswerInput.value,
                        ai_response_html_question: currentSubProblemQuestion
                    });

                    // Heuristic to determine if AI indicates correctness and progression
                    const isSubStepCorrect = aiResponseText.includes(' ') || aiResponseText.includes('') || aiResponseText.includes('爪');
                    const isFinalStep = aiResponseText.includes('驻转专 ') || aiResponseText.includes('住') || aiResponseText.includes('住 转 注');

                    aiFeedbackContent.innerHTML = aiResponseText.replace(/\$(.*?)\$/g, '<span class="latex-formula">$1</span>');
                    aiFeedbackDisplay.classList.remove('hidden');
                    currentSubProblemAnswerInput.value = ''; // Clear input for next step

                    if (isSubStepCorrect && !isFinalStep) {
                        currentStepIndex++; // Move to next step
                        currentStepNumberSpan.textContent = currentStepIndex + 1;
                        currentSubProblemQuestion = aiResponseText; // AI's response is the new question
                    } else if (isFinalStep) {
                        isInStepByStepMode = false; // Exit step-by-step mode
                        stepByStepSection.classList.add('hidden');
                        document.getElementById('initialAnswerSection').classList.remove('hidden');
                        checkAnswerResult = 'correct'; // Mark as overall correct after guidance
                        checkAnswerResultDisplay.className = 'p-4 rounded-lg mb-6 text-center font-semibold text-lg bg-green-100 text-green-700 border border-green-400';
                        checkAnswerResultDisplay.innerHTML = `
                             ! 住转 转 注 爪! 
                            <button id="loadNewProblemBtn" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                                注 砖 砖
                            </button>
                        `;
                        document.getElementById('loadNewProblemBtn').addEventListener('click', loadProblemFromIndex);
                        checkAnswerResultDisplay.classList.remove('hidden');
                    } else {
                        // Sub-step incorrect, stay on same step, AI's feedback will guide re-attempt
                        currentSubProblemQuestion = aiResponseText; // AI's feedback is the new guiding question
                    }

                } else {
                    showErrorMessage(' 转拽砖 砖 转 专.  住 砖.');
                    console.error('Unexpected AI sub-step response structure:', result);
                }
            } catch (error) {
                showErrorMessage(`专注 砖 拽转 砖: ${error.message}.  住 砖.`);
                console.error('Error in checkSubStepAnswer:', error);
            } finally {
                showLoading(false);
            }
        }


        // Function to get AI feedback on the student's uploaded work
        async function getAIFeedbackOnUpload() {
            if (!geminiApiKey) {
                showErrorMessage('  砖专 转 驻转 -API 砖 Gemini 驻 砖砖 转转 AI.');
                return;
            }
            if (!currentProblem || !imageUploadInput.files[0]) {
                showErrorMessage(' 专 砖 注 拽抓 转 砖 注转.');
                return;
            }

            showLoading(true);
            hideErrorMessage();
            aiFeedbackContent.innerHTML = '';
            aiFeedbackDisplay.classList.add('hidden');
            checkAnswerResultDisplay.classList.add('hidden');
            isInStepByStepMode = false; // Ensure not in step-by-step mode
            stepByStepSection.classList.add('hidden');
            document.getElementById('initialAnswerSection').classList.remove('hidden');


            try {
                const prompt = `转 专 转拽 , 驻 专转拽 转 专转 3 转 砖专.
                注 转 : "${currentProblem.question}"
                转 注 转 砖 注转 转  (  砖 砖专 转,  转住  砖 拽转).
                 住驻拽 砖 注专转 注 注 砖注转.
                1. 住  转 注 砖注转 拽注  转砖 住驻转 .
                2.  转砖 , 住驻拽 拽  转拽祝 拽爪专.
                3.  转砖  ,  转 砖 驻砖 砖. 拽 转, 驻专拽 转 注 拽 拽, 拽爪专 注. 爪 转 专砖 住驻专转  注 转专转 砖转. 住专  拽 拽爪专    转 驻转专 砖 专 砖. 驻 转 住专  专转拽.
                4. 砖转砖 -LaTeX   转 砖 砖.
                5. 住 砖, 爪 砖 拽爪专 ( 驻专 专 专 驻砖)   砖 砖 拽砖专 砖  驻转专  砖 拽砖专,  注 转 转 砖 驻转专  砖.`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = geminiApiKey; // Use the saved API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText} - Body: ${errorBody}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    aiFeedbackContent.innerHTML = text.replace(/\$(.*?)\$/g, '<span class="latex-formula">$1</span>');
                    aiFeedbackDisplay.classList.remove('hidden');
                } else {
                    showErrorMessage('Failed to get feedback from AI. Please try again.');
                    console.error('Unexpected AI response structure:', result);
                }
            } catch (error) {
                showErrorMessage(`Error getting AI feedback: ${error.message}.  住 砖.`);
                console.error('Error in getAIFeedbackOnUpload:', error);
            } finally {
                showLoading(false);
            }
        }

        // Function to simplify the current math problem
        async function simplifyProblem() {
            if (!geminiApiKey) {
                showErrorMessage('  砖专 转 驻转 -API 砖 Gemini 驻 砖砖 转转 AI.');
                return;
            }
            if (!currentProblem) {
                showErrorMessage(' 专 砖 拽.');
                return;
            }
            showLoading(true);
            hideErrorMessage();
            aiFeedbackContent.innerHTML = '';
            aiFeedbackDisplay.classList.add('hidden');
            checkAnswerResultDisplay.classList.add('hidden');
            isInStepByStepMode = false; // Exit step-by-step mode
            stepByStepSection.classList.add('hidden');
            document.getElementById('initialAnswerSection').classList.remove('hidden');

            try {
                const prompt = `Given the following math problem from the Israeli 3-point Bagrut curriculum: "${currentProblem.question}"
                Please create a simpler version of this problem. The simpler problem should teach the same core concept but with easier numbers or fewer steps.
                Provide only the new, simplified problem question in Hebrew. Use LaTeX for mathematical expressions.`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = geminiApiKey; // Use the saved API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText} - Body: ${errorBody}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const newQuestion = result.candidates[0].content.parts[0].text;
                    currentProblem.question = newQuestion; // Update global currentProblem
                    currentProblem.difficulty = "驻砖";
                    loadProblemFromIndex(); // Re-render with new problem
                } else {
                    showErrorMessage('Failed to simplify problem. Please try again.');
                    console.error('Unexpected AI response structure:', result);
                }
            } catch (error) {
                showErrorMessage(`Error simplifying problem: ${error.message}.  住 砖.`);
                console.error('Error in simplifyProblem:', error);
            } finally {
                showLoading(false);
            }
        }

        // Function to make the current math problem harder
        async function makeHarderProblem() {
            if (!geminiApiKey) {
                showErrorMessage('  砖专 转 驻转 -API 砖 Gemini 驻 砖砖 转转 AI.');
                return;
            }
            if (!currentProblem) {
                showErrorMessage(' 专 砖 拽.');
                return;
            }
            showLoading(true);
            hideErrorMessage();
            aiFeedbackContent.innerHTML = '';
            aiFeedbackDisplay.classList.add('hidden');
            checkAnswerResultDisplay.classList.add('hidden');
            isInStepByStepMode = false; // Exit step-by-step mode
            stepByStepSection.classList.add('hidden');
            document.getElementById('initialAnswerSection').classList.remove('hidden');

            try {
                const prompt = `Given the following math problem from the Israeli 3-point Bagrut curriculum: "${currentProblem.question}"
                Please create a harder version of this problem. The harder problem should build on the same core concept but with more complex numbers, additional steps, or a more challenging context.
                Provide only the new, harder problem question in Hebrew. Use LaTeX for mathematical expressions.`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = geminiApiKey; // Use the saved API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText} - Body: ${errorBody}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const newQuestion = result.candidates[0].content.parts[0].text;
                    currentProblem.question = newQuestion; // Update global currentProblem
                    currentProblem.difficulty = "拽砖 转专";
                    loadProblemFromIndex(); // Re-render with new problem
                } else {
                    showErrorMessage('Failed to make problem harder. Please try again.');
                    console.error('Unexpected AI response structure:', result);
                }
            } catch (error) {
                showErrorMessage(`Error making problem harder: ${error.message}.  住 砖.`);
                console.error('Error in makeHarderProblem:', error);
            } finally {
                showLoading(false);
            }
        }

        // Function to render chat messages
        function renderChatMessages() {
            chatMessagesDisplay.innerHTML = '';
            chatMessages.forEach((msg, index) => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `p-3 rounded-lg my-1 max-w-[80%] ${
                    msg.sender === 'user' ? 'chat-message-user' : 'chat-message-ai'
                }`;
                msgDiv.innerHTML = msg.text.replace(/\$(.*?)\$/g, '<span class="latex-formula">$1</span>');
                chatMessagesDisplay.appendChild(msgDiv);
            });
            chatMessagesDisplay.scrollTop = chatMessagesDisplay.scrollHeight; // Auto-scroll to bottom
        }

        // Function to send a message in the chat
        async function sendChatMessage() {
            if (!geminiApiKey) {
                showErrorMessage('  砖专 转 驻转 -API 砖 Gemini 驻 砖砖 转转 AI.');
                return;
            }
            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            chatMessages.push({ sender: 'user', text: messageText });
            chatInput.value = '';
            renderChatMessages();
            isChatLoading = true;
            sendChatMessageButton.disabled = true;
            chatInput.disabled = true;

            try {
                const currentChatHistory = chatMessages.map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                }));

                const prompt = `转 专 转拽 , 驻 专转拽 转 专转 3 转 砖专.
                转 砖 转 砖 拽砖专 转拽. 注  爪专 拽转, 拽爪专 注.
                 砖  拽砖专 转拽, 拽砖 转 转拽 砖 转拽.
                砖转砖 -LaTeX   转 转砖转.
                住  驻注  砖 拽爪专   砖转转 住祝 转砖 砖,  注 转 转 砖 砖  驻转专.`;

                const payload = { contents: currentChatHistory };
                const apiKey = geminiApiKey; // Use the saved API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText} - Body: ${errorBody}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponseText = result.candidates[0].content.parts[0].text;
                    chatMessages.push({ sender: 'ai', text: aiResponseText });
                } else {
                    chatMessages.push({ sender: 'ai', text: ' 转拽砖 .  住 住 砖 转 砖转.' });
                    console.error('Unexpected AI chat response structure:', result);
                }
            } catch (error) {
                chatMessages.push({ sender: 'ai', text: `专注 砖: ${error.message}.  住 砖.` });
                console.error('Error in sendChatMessage:', error);
            } finally {
                isChatLoading = false;
                sendChatMessageButton.disabled = false;
                chatInput.disabled = false;
                renderChatMessages();
            }
        }

        // Function to load API key from local storage
        function loadApiKey() {
            const storedKey = localStorage.getItem('geminiApiKey');
            if (storedKey) {
                geminiApiKey = storedKey;
                apiKeyInput.value = storedKey;
                apiKeyStatus.textContent = '驻转 API 注 爪!';
                apiKeyStatus.classList.remove('hidden');
            } else {
                apiKeyStatus.textContent = '  转 驻转 -API 砖.';
                apiKeyStatus.classList.remove('hidden');
                apiKeyStatus.classList.add('text-red-700');
            }
        }

        // Function to save API key to local storage
        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                geminiApiKey = key;
                apiKeyStatus.textContent = '驻转 API 砖专 爪!';
                apiKeyStatus.classList.remove('hidden', 'text-red-700');
                apiKeyStatus.classList.add('text-green-700');
            } else {
                showErrorMessage('  驻转 API 拽.');
                apiKeyStatus.classList.add('text-red-700');
            }
        }

        // Event Listeners
        window.onload = function() {
            loadApiKey(); // Load API key on startup
            populateDropdowns();
            loadProblemFromIndex(); // Load initial problem

            moduleSelect.addEventListener('change', () => {
                populateYears();
                populateQuestions();
                loadProblemFromIndex();
            });
            yearSelect.addEventListener('change', () => {
                populateQuestions();
                loadProblemFromIndex();
            });
            questionSelect.addEventListener('change', loadProblemFromIndex);
            loadProblemButton.addEventListener('click', loadProblemFromIndex);
            checkAnswerButton.addEventListener('click', checkTypedAnswer);
            checkSubStepButton.addEventListener('click', checkSubStepAnswer);
            imageUploadInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    selectedImageName.textContent = `拽抓 专: ${e.target.files[0].name}`;
                } else {
                    selectedImageName.textContent = '';
                }
            });
            simplifyProblemButton.addEventListener('click', simplifyProblem);
            makeHarderProblemButton.addEventListener('click', makeHarderProblem);
            getAIFeedbackOnUploadButton.addEventListener('click', getAIFeedbackOnUpload);
            sendChatMessageButton.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            saveApiKeyButton.addEventListener('click', saveApiKey); // New event listener for save button
        };
    </script>
</body>
</html>
